<%
  @menu_aggiuntivi = '<li>
          <a id="pageSave" onclick="pageSave();" class="error button"><i class="fi-save"></i> Salva</a>
        </li>
        <li>
          <a id="pagePreview" onclick="pagePreview();" class="toolbar warning button"><i class="fi-eye"></i> Page preview</a>
        </li>
        <li>
          <a id="inlineEdit" onclick="inlineEdit();" class="toolbar button"><i class="fi-page"></i> Inline edit</a>
        </li>
        <li>
          <a id="layoutDesign" onclick="layoutDesign();" class="toolbar button"><i class="fi-pencil"></i> Layout design</a>
        </li>'.html_safe
%>

<div class="reveal" id="finestra_modale" data-reveal>
  <button class="close-button" data-close aria-label="Close modal" type="button">
    <span aria-hidden="true">&times;</span>
  </button>
</div>

    <%
      header = @page.trova_header if !@page.header # non lo mostro se sto modificando proprio un header

      logger.debug "header3: #{header}"

      footer = @page.trova_footer if !@page.footer
    %>

    <%= render(header.rows.order('ordine ASC')) if header %>

    <%= render(@page.rows.order('ordine ASC')) %>

    <%= render(footer.rows.order('ordine ASC')) if footer %>

<script>

  $(function() {
    // Turn off automatic editor creation first.
    CKEDITOR.disableAutoInline = true;

    // prepara i menù contestuali
    $.contextMenu({
      selector: '.columns',
      zIndex: 1500,
      callback: function (action, options) {
        var id = $(this).attr('id').substr(6);
        // var m = "clicked: " + action + " on " + id;
        // window.console && console.log(m);

        switch (action) {
          case 'dialog_sfondo':
            $.ajax('/columns/' + id + '/' + action).done(function (data) {
              $("#finestra_modale").html(data).foundation("open");
            });
            break;
          case 'dialog_immagine':
            $.ajax('/columns/' + id + '/' + action).done(function (data) {
              $("#finestra_modale").html(data).foundation("open");
            });
            break;
          default:
            $.ajax({
              url: '/columns/' + id + '/' + action + '.js',
              type: 'POST',
              data: {
                authenticity_token: '<%= form_authenticity_token %>'
              }
              // success: function (response) {
              //   alert("La pagina è stata salvata.");
              // }
              // document.getElementById( 'notice' ).innerHTML = 'La pagina &egrave; stata salvata.';*/
            });
        }
      },
      items: {
        "inserisci_riga_prima": {name: "<i class='fi-arrow-up'></i>&nbsp;&nbsp;Inserisci riga prima", isHtmlName: true},
        "inserisci_riga_dopo": {name: "<i class='fi-arrow-down'></i>&nbsp;&nbsp;Inserisci riga dopo", isHtmlName: true},
        "estendi_riga": {name: "<i class='fi-arrows-expand'></i>&nbsp;Estendi riga", isHtmlName: true},
        "riduci_riga": {name: "<i class='fi-arrows-compress'></i>&nbsp;Comprimi riga", isHtmlName: true},
        "elimina_riga": {name: "<i class='fi-trash'></i>&nbsp;&nbsp;Elimina riga", isHtmlName: true},
        "sep1": "---------",
        "inserisci_colonna_prima": {name: "<i class='fi-arrow-left'></i>&nbsp;Inserisci colonna prima", isHtmlName: true},
        "inserisci_colonna_dopo": {name: "<i class='fi-arrow-right'></i>&nbsp;Inserisci colonna dopo", isHtmlName: true},
        "allarga_colonna": {name: "<i class='fi-arrows-expand'></i>&nbsp;Allarga colonna", isHtmlName: true},
        "stringi_colonna": {name: "<i class='fi-arrows-compress'></i>&nbsp;Stringi colonna", isHtmlName: true},
        "elimina_colonna": {name: "<i class='fi-trash'></i>&nbsp;&nbsp;Elimina colonna", isHtmlName: true},
        "sep2": "---------",
        "dialog_sfondo": {name: "<i class='fi-paint-bucket'></i>&nbsp;Sfondo...", isHtmlName: true},
      }
    });

    // ...e li disabilita
    $('.columns').each(function () {
      var $this = $(this);
      $this.contextMenu(false);
    });

    // nasconde i pulsanti di gestione delle immagini
    $('.gestione-immagini').hide();

      /*
       $('.context-menu-one').on('click', function(e){
       console.log('clicked', this);
       })*/

    $('.mioslider').slick({
      slidestoshow: 1,
      slidestoscroll: 1,
      autoplay: true,
      autoplayspeed: 2000,
      zIndex: 100,
      arrows: true
    });
  });


  // salva il contenuto di tutti gli editor inline
  function pageSave() {

    for (instance in CKEDITOR.instances) {
      var editor = CKEDITOR.instances[instance]; // CKEDITOR.instances.editor1;
      var data = editor.getData();
      var id = editor.name.substr(6);

      // remember to use encodeURIComponent to properly encode the data that is being sent.
      // document.getElementById( 'editorcontent2' ).innerHTML = data;

      // Send contents to server
      $.ajax({
        url: '/columns/' + id + '/editor_update',
        type: 'POST',
        data: {
          contenuto: data,
          authenticity_token: '<%= form_authenticity_token %>'
        },
        // success: function (response) {
        //   alert("La pagina è stata salvata.");
        // }
      });
    }

    // document.getElementById( 'notice' ).innerHTML = 'La pagina &egrave; stata salvata.';
    return false;

  }

  function pagePreview() {
    pageSave()

    // disabilita gli editor inline
    for (instance in CKEDITOR.instances) {
      var editor = CKEDITOR.instances[instance];

      if(editor) {
        editor.destroy();
        elemento = document.getElementById(editor.name)

        elemento.setAttribute('contenteditable', false);
      }
    }

    // disabilita i menù contestuali
    $('.columns').each(function () {
      var $this = $(this);
      $this.contextMenu(false);
    });
    $('.columns').removeClass('bordo_layout');

    $('.toolbar').attr('class','toolbar button');
    $('#pagePreview').attr('class','toolbar warning button');

    // nasconde i pulsanti di gestione delle immagini
    $('.gestione-immagini').hide();
  }

  function inlineEdit() {
    // abilita gli editor inline
    $('.inline-editor').attr('contenteditable', true);
    $('.inline-editor').each(function() {
      CKEDITOR.inline(this);
    });

    // configurazione particolare:
    for (instance in CKEDITOR.instances) {
      var editor = CKEDITOR.instances[instance];
      var id = editor.name.substr(6);

      if(editor) {
        editor.config.filebrowserImageBrowseUrl = "/ckeditor/pictures?column_id=" + id;
        editor.config.filebrowserImageUploadUrl = "/ckeditor/pictures?column_id=" + id;
        editor.config.skin = "minimalist";
        editor.config.stylesSet = "my_styles:/js/ckeditor_my_styles.js";
      }
    }

    // disabilita i menù contestuali
    $('.columns').each(function () {
      var $this = $(this);
      $this.contextMenu(false);
    });
    $('.columns').removeClass('bordo_layout');

    $('.toolbar').attr('class','toolbar button');
    $('#inlineEdit').attr('class','toolbar warning button');

    // visualizza i pulsanti di gestione delle immagini
    $('.gestione-immagini').show();
  }

  function layoutDesign() {
    pageSave()
    // disabilita gli editor inline
    for (instance in CKEDITOR.instances) {
      var editor = CKEDITOR.instances[instance];

      editor.destroy();
      elemento = document.getElementById( editor.name )

      elemento.setAttribute( 'contenteditable', false );
    }

    // abilita i menù contestuali
    $('.columns').each(function () {
      var $this = $(this);
      $this.contextMenu(true);
    });
    $('.columns').addClass('bordo_layout');

    $('.toolbar').attr('class','toolbar button');
    $('#layoutDesign').attr('class','toolbar warning button');

    // visualizza i pulsanti di gestione delle immagini
    $('.gestione-immagini').show();
  }

  function aggiungiImmagine(id) {
    $.ajax('/columns/' + id + '/dialog_immagine').done(function (data) {
      $("#finestra_modale").html(data).foundation("open");
    });
  }

  function eliminaImmagine(id) {
    $.ajax({
      url: '/column_images/' + id + '/elimina.js',
      type: 'POST',
      data: {
        authenticity_token: '<%= form_authenticity_token %>'
      }
    });
  }

  function modificaImmagine(id) { // attenzione: è l'id dell'immagine, non della colonna
    $.ajax('/columns/' + id + '/modifica_immagine').done(function (data) {
      $("#finestra_modale").html(data).foundation("open");
    });
  }
</script>